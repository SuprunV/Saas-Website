variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
    # Minu konteineri registri aadress AWS-s (Amazon Elastic Container Registry)
    # Asenda MINU_REGISTRI_NIMI
    DOCKER_REGISTRY: 662032419283.dkr.ecr.eu-north-1.amazonaws.com/beautyservice
    DOMAIN: beautyservice.itb2203.tautar.ee

stages:
    #- build
    #- api_test
    - deploy

deploy:
    image: docker:20.10.21-alpine3.16
    when: manual
    only:
        - master
        - main
    before_script:
        # teeme kindlaks, et ssh on installitud
        - "which ssh-agent || ( apt-get update -y && apt-get install openssh-client git -y )"

        # käivitame ssh
        - eval $(ssh-agent -s)

        # loome ssh kausta ja anname ssh kaustas lugemise, kirjutamise ja käivitamise õigused
        - mkdir -p ~/.ssh
        - chmod 700 ~/.ssh

        # leiame kõik serveri public key-d ja usaldame neid runneri keskkonnas
        - ssh-keyscan ${DOMAIN} >> ~/.ssh/known_hosts
        - chmod 644 ~/.ssh/known_hosts

    script:
        # loeme GitLabi muutujatest private key
        - echo "$SSH_PRIVATE_KEY"
        - ssh-add <(echo "$SSH_PRIVATE_KEY" | tr -d '\r')

        # loome ssh ühenduse
        - ssh ubuntu@${DOMAIN} "(aws ecr get-login-password --region eu-north-1 | docker login --username AWS --password-stdin ${DOCKER_REGISTRY}) && CI_COMMIT_SHA=${CI_COMMIT_SHA} docker compose -f ~/app/docker-compose.yml up -d"
    after_script:
        - exit
    stage: deploy
